<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>图片标注</title>
    <style>
        #image-display {
            max-width: 500px;
            max-height: 500px;
        }
        .category-button {
            margin: 5px;
        }
    </style>
</head>
<body>
    <img id="image-display" src="" alt="图片加载中...">
    <div>
        <button class="category-button" data-category="类别1">类别1</button>
        <button class="category-button" data-category="类别2">类别2</button>
        <button class="category-button" data-category="类别3">类别3</button>
        <button class="category-button" data-category="类别4">类别4</button>
        <button class="category-button" data-category="类别5">类别5</button>
    </div>
    <button id="confirm-button">确认</button>
    </div>
    <button id = "prev-button">Previous</button>
    <button id = "next-button">Next</button>

<!-- javascript -->
    <script>
        // let selectedCategory = null;
        // let currentImageIndex = 0;
        // const images = ['10-0.png', '13-0.png', '14-0.png']; // 图片数组

        // function loadImage() {
        //     document.getElementById('image-display').src = images[currentImageIndex];
        // }

        // document.querySelectorAll('.category-button').forEach(button => {
        //     button.addEventListener('click', function() {
        //         selectedCategory = this.getAttribute('data-category');
        //         alert('已选择: ' + selectedCategory);
        //     });
        // });

        // document.getElementById('confirm-button').addEventListener('click', function() {
        //     if (selectedCategory) {
        //         const annotation = {
        //             image: images[currentImageIndex],
        //             category: selectedCategory
        //         };
        let selectedCategory = null;
        let currentImageIndex = 0;
        const imageFolder = 'UCR'; // 图片文件夹名
        const csvFilePath = 'UCR/img_list.csv'; // 图片列表文件路径
        let images = []; // 图片数组

        // 获取图片列表
        async function fetchImages() {
            try {
                const response = await fetch(csvFilePath);
                const csvText = await response.text();
                images = csvText.split('\n').map(line => line.trim()).filter(line => line.length > 0);
                loadImage();
            } catch (error) {
                console.error('Error fetching images:', error);
            }
        }       

        // 加载当前图片
        function loadImage() {
            if (images.length > 0) {
                document.getElementById('image-container').innerHTML = `<img id="image-display" src="${imageFolder}/${images[currentImageIndex]}" alt="Image">`;
            }
        }
        //处理上一张
        document.getElementById('prev-button').addEventListener('click', function() {
            if (currentImageIndex > 0) {
                currentImageIndex--;
                loadImage();
            }
        });

        // 处理下一张图片按钮点击
        document.getElementById('next-button').addEventListener('click', function() {
            if (currentImageIndex < images.length - 1) {
                currentImageIndex++;
                loadImage();
            }
        });
        document.querySelectorAll('.category-button').forEach(button => {
            button.addEventListener('click', function() {
                // 重置所有按钮的颜色
                document.querySelectorAll('.category-button').forEach(btn => {
                    btn.style.backgroundColor = '';
                });

                // 设置选中的类别和按钮颜色
                selectedCategory = this.getAttribute('data-category');
                this.style.backgroundColor = 'yellow'; // 你可以根据需要更改颜色
            });
        });

        document.getElementById('confirm-button').addEventListener('click', function() {
            if (selectedCategory) {
                const annotation = {
                    image: images[currentImageIndex],
                    category: selectedCategory
                };

                // 使用GitHub API更新annotations.json
                const token = 'YOUR_GITHUB_TOKEN'; // 替换为你的GitHub Token
                const repo = 'YOUR_USERNAME/image-annotation'; // 替换为你的GitHub用户名和仓库名
                const filePath = 'annotations.json';

                fetch(`https://api.github.com/repos/${repo}/contents/${filePath}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `token ${token}`
                    }
                })
                .then(response => response.json())
                .then(data => {
                    const sha = data.sha; // 获取文件的SHA值
                    const currentData = JSON.parse(atob(data.content)); // 解码内容

                    // 更新内容
                    currentData.push(annotation);
                    const updatedContent = btoa(JSON.stringify(currentData, null, 2)); // 编码为Base64

                    // 提交更新
                    return fetch(`https://api.github.com/repos/${repo}/contents/${filePath}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: 'Update annotations',
                            content: updatedContent,
                            sha: sha
                        })
                    });
                })
                .then(() => {
                    alert('标注已保存');
                    currentImageIndex = (currentImageIndex + 1) % images.length;
                    loadImage();
                })
                .catch(error => console.error('Error:', error));
            } else {
                alert('请选择一个类别');
            }
        });

        // 初始加载图片
        loadImage();
    </script>
</body>
</html>